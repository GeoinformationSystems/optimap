{% extends "base.html" %}

{% block title %}All works - {% endblock %}

{% block content %}
  <div class="container py-5 works-page">
    <h1>All Works</h1>

    {% if is_admin %}
      <p class="alert alert-info">
        <strong>Admin view:</strong> You can see all works regardless of status. Status labels are shown next to each entry.
      </p>
    {% endif %}

    <!-- Pagination controls (top) -->
    {% if page_obj %}
    <div class="pagination-controls mb-4">
      <div class="row align-items-center">
        <div class="col-md-6">
          <p class="mb-2">
            Showing {{ page_obj.start_index }} to {{ page_obj.end_index }} of {{ page_obj.paginator.count }} works
          </p>
        </div>
        <div class="col-md-6 text-md-right">
          <form method="get" class="form-inline justify-content-md-end">
            <label for="page-size" class="mr-2">Works per page:</label>
            <select name="size" id="page-size" class="form-control form-control-sm mr-2" onchange="this.form.submit()">
              {% for option in page_size_options %}
                <option value="{{ option }}" {% if option == page_size %}selected{% endif %}>{{ option }}</option>
              {% endfor %}
            </select>
            <input type="hidden" name="page" value="1">
          </form>
        </div>
      </div>

      <!-- Pagination nav -->
      <nav aria-label="Works pagination" class="mt-3">
        <ul class="pagination justify-content-center">
          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page=1&size={{ page_size }}" aria-label="First">
                <span aria-hidden="true">&laquo;&laquo;</span>
              </a>
            </li>
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.previous_page_number }}&size={{ page_size }}" aria-label="Previous">
                <span aria-hidden="true">&laquo;</span>
              </a>
            </li>
          {% else %}
            <li class="page-item disabled">
              <span class="page-link">&laquo;&laquo;</span>
            </li>
            <li class="page-item disabled">
              <span class="page-link">&laquo;</span>
            </li>
          {% endif %}

          {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
              <li class="page-item active"><span class="page-link">{{ num }} <span class="sr-only">(current)</span></span></li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
              <li class="page-item"><a class="page-link" href="?page={{ num }}&size={{ page_size }}">{{ num }}</a></li>
            {% endif %}
          {% endfor %}

          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.next_page_number }}&size={{ page_size }}" aria-label="Next">
                <span aria-hidden="true">&raquo;</span>
              </a>
            </li>
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&size={{ page_size }}" aria-label="Last">
                <span aria-hidden="true">&raquo;&raquo;</span>
              </a>
            </li>
          {% else %}
            <li class="page-item disabled">
              <span class="page-link">&raquo;</span>
            </li>
            <li class="page-item disabled">
              <span class="page-link">&raquo;&raquo;</span>
            </li>
          {% endif %}
        </ul>
      </nav>
    </div>
    {% endif %}

    <!-- Works list -->
    <div class="works-list">
      {% for work in works %}
        <div class="work-item mb-3 pb-3 border-bottom">
          <h5 class="work-title mb-2">
            <a href="{{ work.href }}" {% if not work.href|slice:":1" == "/" %}target="_blank" rel="noopener"{% endif %} title="{% if work.doi %}View details for: {% endif %}{{ work.title }}">
              {{ work.title }}
            </a>
            {% if is_admin and work.status %}
              <span class="badge ml-2
                {% if work.status_code == 'p' %}badge-success
                {% elif work.status_code == 'd' %}badge-secondary
                {% elif work.status_code == 't' %}badge-warning
                {% elif work.status_code == 'w' %}badge-danger
                {% elif work.status_code == 'h' %}badge-info
                {% elif work.status_code == 'c' %}badge-primary
                {% endif %}">{{ work.status }}</span>
            {% endif %}
          </h5>
          <div class="work-metadata text-muted">
            {% if work.authors %}
              <span class="work-authors">
                <i class="fas fa-users" aria-hidden="true"></i>
                {% if work.authors|length > 3 %}
                  {{ work.authors.0 }}, {{ work.authors.1 }}, {{ work.authors.2 }}, et al. ({{ work.authors|length }} authors)
                {% else %}
                  {{ work.authors|join:", " }}
                {% endif %}
              </span>
              <span class="mx-2">·</span>
            {% endif %}
            {% if work.source %}
              <span class="work-source">
                <i class="fas fa-book" aria-hidden="true"></i> {{ work.source }}
              </span>
              <span class="mx-2">·</span>
            {% endif %}
            {% if work.doi %}
              <span class="work-doi">
                <i class="fas fa-link" aria-hidden="true"></i>
                <a href="https://doi.org/{{ work.doi }}" target="_blank" rel="noopener" title="View DOI: {{ work.doi }}">
                  DOI: {{ work.doi }}
                </a>
              </span>
            {% endif %}
          </div>
        </div>
      {% empty %}
        <p class="alert alert-warning">No works found.</p>
      {% endfor %}
    </div>

    <!-- Pagination controls (bottom) -->
    {% if page_obj and page_obj.paginator.num_pages > 1 %}
    <div class="pagination-controls mt-4">
      <nav aria-label="Works pagination" class="mt-3">
        <ul class="pagination justify-content-center">
          {% if page_obj.has_previous %}
            <li class="page-item">
              <a class="page-link" href="?page=1&size={{ page_size }}" aria-label="First">
                <span aria-hidden="true">&laquo;&laquo;</span>
              </a>
            </li>
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.previous_page_number }}&size={{ page_size }}" aria-label="Previous">
                <span aria-hidden="true">&laquo;</span>
              </a>
            </li>
          {% else %}
            <li class="page-item disabled">
              <span class="page-link">&laquo;&laquo;</span>
            </li>
            <li class="page-item disabled">
              <span class="page-link">&laquo;</span>
            </li>
          {% endif %}

          {% for num in page_obj.paginator.page_range %}
            {% if page_obj.number == num %}
              <li class="page-item active"><span class="page-link">{{ num }} <span class="sr-only">(current)</span></span></li>
            {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
              <li class="page-item"><a class="page-link" href="?page={{ num }}&size={{ page_size }}">{{ num }}</a></li>
            {% endif %}
          {% endfor %}

          {% if page_obj.has_next %}
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.next_page_number }}&size={{ page_size }}" aria-label="Next">
                <span aria-hidden="true">&raquo;</span>
              </a>
            </li>
            <li class="page-item">
              <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&size={{ page_size }}" aria-label="Last">
                <span aria-hidden="true">&raquo;&raquo;</span>
              </a>
            </li>
          {% else %}
            <li class="page-item disabled">
              <span class="page-link">&raquo;</span>
            </li>
            <li class="page-item disabled">
              <span class="page-link">&raquo;&raquo;</span>
            </li>
          {% endif %}
        </ul>
      </nav>
    </div>
    {% endif %}

    <!-- Statistics -->
    {% if statistics %}
    <div class="works-statistics mt-5 pt-4 border-top">
      <h2>Statistics</h2>
      <div class="row">
        <div class="col-md-6">
          <dl class="row">
            <dt class="col-sm-8">Total works in database:</dt>
            <dd class="col-sm-4 text-right">{{ statistics.total_works|default:"0" }}</dd>

            <dt class="col-sm-8">Published works:</dt>
            <dd class="col-sm-4 text-right">{{ statistics.published_works|default:"0" }}</dd>

            <dt class="col-sm-8">With geographic metadata:</dt>
            <dd class="col-sm-4 text-right">{{ statistics.with_geometry|default:"0" }}</dd>

            <dt class="col-sm-8">With temporal extent:</dt>
            <dd class="col-sm-4 text-right">{{ statistics.with_temporal|default:"0" }}</dd>
          </dl>
        </div>
        <div class="col-md-6">
          <dl class="row">
            <dt class="col-sm-8">With author information:</dt>
            <dd class="col-sm-4 text-right">{{ statistics.with_authors|default:"0" }}</dd>

            <dt class="col-sm-8">With DOI:</dt>
            <dd class="col-sm-4 text-right">{{ statistics.with_doi|default:"0" }}</dd>

            <dt class="col-sm-8">With abstract:</dt>
            <dd class="col-sm-4 text-right">{{ statistics.with_abstract|default:"0" }}</dd>

            <dt class="col-sm-8">Open access:</dt>
            <dd class="col-sm-4 text-right">{{ statistics.open_access|default:"0" }}</dd>
          </dl>
        </div>
      </div>
      <div class="row mt-3">
        <div class="col-12">
          <div class="alert alert-info">
            <strong>Complete metadata coverage:</strong>
            {{ statistics.with_complete_metadata|default:"0" }} works ({{ statistics.complete_percentage|default:"0" }}%)
            have geographic metadata, temporal extent, and author information.
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <!-- API Link -->
    {% if api_url %}
    <div class="api-link mt-4 pt-3 border-top">
      <p>
        <i class="fas fa-code" aria-hidden="true"></i>
        <strong>API Access:</strong>
        <a href="{{ api_url }}" target="_blank" rel="noopener" title="Access this data via API">
          View this page as JSON (API)
        </a>
      </p>
      <p class="text-muted small">
        The API returns the same works displayed on this page with full metadata in JSON format.
      </p>
    </div>
    {% endif %}

  </div>
{% endblock %}
